### 7.3 집계 스테이지
- 집계 스테이지는 데이터 파이프라인에서 데이터 변환이 이루어지는 단계
- 각 단계에서 데이터를 처리하여 후속 단계에서 추가 처리가 가능한 형태의 문서 생성
    - 집계 스테이지도 하위 여러 단계로 나눠져 있는가?
    - 결국 1차 문서를 가공하여 목적에 맞게 가공 후 2차 문서로 출력하는 과정
- 파이프라인 핵심 단계
    - `$match` : 
        - 지정된 조건에 부합하는 문서만을 선별하여 다음 단계로 전달
        - 초기 단계에서 바람직
        - 필요한 문서만을 선별하여 후속 단계로 전달함으로써 처리 효율을 크게 향상 가능
        ```
        db.users.aggregate([{ $match: { age: { $gt: 22} } }]); # 22세 이상의 모든 사용자 찾기
        ```
    - `$limit` :
        - 필요한 결과만 얻기 위해 파이프라인 초기 단계에서 사용
        - 이를 통해 후속 단계에서 처리해야 할 문서의 수를 제한하여 처리 효율 최적화
        ```
        db.users.aggregate([{ $limit: 3}]);
        ```
    - `$sort`  :
        - 정렬 인덱스 구성된 상태에서 정렬이 필요한 경우 (최적화)
        - 적절한 인덱스 > 정렬 작업: 시스템의 처리 속도 상승 가능
        ```
        db.users.aggregate([{ $sort: { age: -1 } }]);
        ```
    - `$skip`  :
        - 처음 양의 정수 N개의 건너뛰고 나머지를 다음 단계로 그대로 전달
        ```
        db.users.aggregate([ $skip: 10 ]);
        ```
    - `$project`, `$set`, `addFields` :
        - 문서의 구조를 변경하는 데 사용
        - 주로 파이프라인 최종 단계에서 활용
        - 클라이언트에게 전달한 특정 필드 선별 & 구조화
        - 최종 출력 형태를 결정하는 만큼 데이터의 효율적인 전달과 활용을 위해 신중히 구성해야 함
        ```
        db.users.aggregate([{ $project: { username: 1, phoneNumber: 1} } ]);
        ```
    - `$group`
        - 데이터 정제, 축소 작업 이후 특정 기준에 따라 체계적으로 그룹화하는데 사용
        - 이를 통해 구조화된 분석과 효율적인 집계 가능
        ```
        # 사용자의 평균 연령을 구하고 국가별로 그룹화
        db.users.aggregate([{ $group: { _id: $country, averageAge: { $avg: $age } } }])
        ``` 
    - `$unwind`
        - 배열 형태의 필드를 분리하여 요소별로 독립된 새로운 문서를 생성
        - 연산자를 통해 배열 데이터를 개별 문서로 변환함으로써 더 상세한 분석과 처리가 가능함
        ```
        # 각 사용자에 관해 취미 배열을 풀고 각 추미에 관한 문서를 생성합니다.
        db.users.aggregate([{ $unwind, $hobbies }])
        ```
    - `$lookup`
        - 서로 다른 컬렉션 간의 왼쪽 외부 조인을 수행하는 연산자
        - 현재 집계 중인 컬렉션의 문서를 다른 컬렉션의 문서와 연결하는 데 사용

        - 구성요소
            - `from`: 필드는 연결하고자 하는 컬렉션을 식별
            - `localField`: foreignField는 각각 입력 문서와 from 컬렉션의 문서에서 지정된 필드를 나타냄
            - `as`: 입력 문서에 추가된 새 배열 필드의 이름을 결정
        ```

        ```
    - `geoNear`
        - 지정된 위치를 기준으로 문서들을 거리순으로 정렬
        - 가장 가까운 위치부터 먼 위치 순으로 문서들을 배열
        - 이를 위해 해당 컬렉션에 지리 공간 정보가 포함된 필드와 그에 관한 지리 공간 인덱스가 반드시 구성되어 있어야 함
        - 제약 사항
            - 첫 번째 단계에서만 사용 가능
        ```
        db.restaurants.aggregate([
            {
                $geoNear: {
                    near: {
                        type: "Point",
                        coordinate: [-73.99279, 40.719296]
                    },
                    distanceField: "distance",
                    maxDistance: 2000,
                    spherical: true
                }
            }
        ])
        ```
    - `$redact`
        - 문서에 저장된 메타데이터나 속성을 기반으로 문서의 접근 범위를 효과적으로 제한
        - 이는 주로 조직의 데이터 접근 제어 정책을 구현하는 데 활용
        - 사용자의 권한 수준에 따라 문서의 특정 부분에 관한 접근을 동적으로 제어

        cf)
        - 문서나 텍스트에서 민감한 정보를 삭제하거나 가리는 행위
        - 주로 개인정보 기밀 데이터 등을 보호하기 위해 특정 부분을 가리거나, 수정하거나 제거하는데 사용됨
        - 문서에서 이름, 주소 등을 별표(*)로 대체하는 것이 redaction
        
        ```
        db.docs.aggregate([
            {
                $redact: {
                    $cond: {
                        if: { $eq: ["$access", "read"] },
                        then: "$$DESCEND",
                        else: "$$PRUNE",
                    }
                }
            }
        ])
        ```
    - `$replaceWith`
        - 입력 문서의 내용을 지정된 새로운 문서로 완전히 대체하는 데 사용
        - 연산자를 통해 문서의 구조를 근본저긍로 변경하거나 재구성
        - 복잡한 중첩 구조 단순화, 특정 하위 문서를 상위 수준으로 승격시키는데 효과적 

        ```
        db.users.aggregate([
            {
                $replaceWith: $profile
            }
        ])
        ```

### 7.4 쿼리 기술
쿼리 작성은 단순히 데이터를 검색하는 데 그치지 않고, 
시스템 자원을 최적화하고 신속한 데이터 분석을 가능하게 하는 등
성능 최적화에 긴밀히 맞닿아 있다.

#### 7.4.1 논리와 비교 연산자
```
$not, $and, $or, $nor, $in, $nin, $eq, $ne, $gt, $gte, $lt, $lte
```

#### 7.4.2 배열 쿼리와 조작
```
$all, $elemMatch, $size, $push, $pull, $addToSet, $pop, 
```

- `$all`
    - 배열 필드가 특정 요소들을 모두 포함하는 문서를 검색할 때 사용
    - 여러 조건을 동시에 만족하는 배열 데이터를 찾아내는데 효과적
    
    ```
    db.books.find({ tags: { $all: ["nosql", "mongodb"] } });
    ```
- `$elemMatch`
    - 지정된 모든 쿼리 조건을 일치하는 요소가 하나 이상 있는 배열 필드가 포함된 문서를 찾음
- `$size`
    - 배열이 정확히 지정된 수의 요소를 포함하고 있는 문서를 찾아냄
- `$push`
    - 배열에 새로운 요소를 추가하는 기능을 수행
    ```
    db.books.updateOne( {name: "AirFly" }, { $push: {destinations: "Tokyo" } })
    ```
- `$pull`
    - 배열에서 조건에 맞는 요소를 제거하는 기능을 수행
- `$addToSet`
    - 배열 내에 동일한 값이 없는 경우에만 새로운 요소를 추가하는 기능
- `$pop`
    - 배열의 처음이나 끝에서 요소를 삭제할 때 사용
    - -1을 전달하면 배열의 첫 번째 요소가 삭제
    - 1을 전달하면 마지막 요소가 삭제 (0 아님 주의)

#### 7.4.3 배열 필드의 출력 제어 기법
- 몽고DB에서 출력 제어 기법은 쿼리 결과에서 배열 필드의 반환 범위를 지정한다.
- `$elemMatch`, `$slice` 등과 같은 연산자를 활용하면 필요한 데이터만 선별적으로 조회 가능
- 네트워크 대역폭 사용량과 처리 시간을 줄여 작업의 효율성을 크게 높일 수 있음

### 7.5 인덱스와 쿼리 최적화
- 인덱스는 쿼리 성능을 높이기 위한 핵심적인 데이터 구조
- 인덱스가 없다면 몽고DB는 원하는 결과를 찾기 위해 컬렉션의 모든 문서를 검색해야 함
- 반면, 인덱스를 활용하면 검색 대상 문서의 수를 대폭 줄여 쿼리 처리가 훨씬 효율적으로 이루어짐

#### 7.5.1 인덱스 사용의 장점
#### 7.5.2 인덱스 종류
1. 단일 필드 인덱스
2. 복합 인덱스
3. 다중키 인덱스 
4. 복합 다중키 인덱스
5. 텍스트 인덱스
6. 와일드카드 인덱스
7. TTL 인덱스
8. 고유 인덱스
9. 부분 인덱스

### 7.6 몽고DB 위치 기반 데이터
- 지리 공간 기능은 위치 기반 서비스를 효과적으로 구현할 수 있도록 설계
- 특수 인덱스와 연산자를 통해 지리적 데이터를 효율적으로 처리할 수 있음
- 지도 서비스, 위치 검색 등에 활용
- 좌표
  - 위치 데이터를 표현하는 기본 방식 (경도, 위도 값 구성 배열)
  - MongoDB 2d 인덱스 (db.collection.createIndex({ loc: "2d" });)

#### 7.6.1 GeoJSON 개체
GeoJSON에는 세 가지 유형이 있음

1. 점(Point): 경도와 위도 좌표로 공간상의 한 지점
2. 선(LineString): 두 개 이상의 점들이 연결되어 선을 형성
3. 다각형: 점들이 연결되어 닫힌 고리를 만들어, 이는 특정 영역을 정의

#### 7.6.2 위치 기반 인덱스
위치 기반 인덱스는 몽고DB에서 제공하는 특수 데이터 구조.
공간 정보를 효율적으로 처리하여 위치 기반 검색의 성능을 크게 향상

- 2d 인덱스
  - 2차원 평면에서의 위치 데이터를 효율적으로 처리하기 위해 설계
  - 위도와 경도로 구성된 좌표 데이터를 다룰 때 사용
  - ex. (공간 검색 작업) 특정 위치 주변 장소 검색, 주어진 영역 내의 위치 검색 등...
- 2dsphere 인덱스
  - 지구 표면상의 위치 데이터를 처리하기 위해 특별히 설계된 인덱스
  - ex. (공간 검색 작업) 특정 지역 내 검색, 주변 지역 탐색, 정확한 위치 매칭

위치 데이터는 GeoJSON 형식이나 일반 좌표 형태로 저장할 수 있으며,
일반 좌표는 자동으로 GeoJSON 형식으로 변환
```
db.collection.createIndex({ loc: "2d" })
db.collection.createIndex({ loc: "2dsphere" })
```

#### 7.6.3 위치 기반 연산자
```
$near
$nearSphere
$geoWithin
$geoIntersects
$maxDistance, $near, $nearSphere
```
